# TravisCI

This integration adds TravisCI notifications via a new Webhook in Rocket.Chat.

## Receive Alerts

1. Create a new **Incoming Webhook**.
2. Select the desired channel to receive the alerts. You should create a dedicated channel for your notifications.
3. Select the desired account to post alerts. You should create a dedicated account just for notifications.
4. Set the **Enable Scripts** option to `True`.
5. Copy the javascript below and paste it in the **Script** field.
6. Save the integration to generate a webhook URL and a secret.
7. In your `.travis.yml` file add the Webhooks parameter with the _webhook URL generated_.

```yaml
  notifications:
      webhooks: <webhook_url_generated>
```

This script generates notifications for the following build events:

- Build finished status for any code pushed
- Build finished status for new Pull Request

![Screenshot of messages generated by TravisCI integration script](travis-ci.png)

**Note:** The message color is green if the status is passed, otherwise it is red.

```javascript
const buildMessage = (obj) => {
  const min = Math.floor(obj.duration / 60);
  const sec = obj.duration - min * 60;

  let template = `Build [#${obj.number}](${obj.build_url})`;
  template += ` ([${obj.commit.substring(0, 7)}](${obj.compare_url})) of`
  template += ` ${obj.repository.owner_name}/${obj.repository.name}@${obj.branch}`;
  if(obj.pull_request) {
     let pr_url = `https://github.com/${obj.repository.owner_name}/`;
     pr_url += `${obj.repository.name}/pull/${obj.pull_request_number}`;
     template += ` in PR [#${obj.pull_request_number}](${pr_url})`;
  }
  template += ` by ${obj.author_name} ${obj.state} in ${min} min ${sec} sec`;

  let status_color = '#36A64F';
  if(obj.state !== 'passed') {
    status_color = '#A63636'
  }

  return {
    text: template,
    color: status_color
  };
};

class Script {
  process_incoming_request({ request }) {
    msg = buildMessage(request.content);

    return {
      content:{
        attachments: [
          {
            text: msg.text,
            color: msg.color
          }
        ]
      }
    };
  }
}
```

Read the [TravisCI documentation](<https://docs.travis-ci.com/user/notifications/#Configuring-webhook-notifications>) to learn more about customizations.
